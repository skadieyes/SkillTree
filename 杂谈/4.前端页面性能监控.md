# 前端页面性能监控

## 参考资料

> [知乎-10分钟彻底搞懂前端页面性能监控](https://zhuanlan.zhihu.com/p/82981365
)
> [前端性能优化之性能测试](https://juejin.im/post/5a41abb35188252a3d383eb8)

## Why
> 一个页面性能差的话会大大影响用户体验。用户打开页面等待的太久，可能会直接关掉页面，甚至就不再使用了，这种情况在移动端更加明显，移动端用户对页面响应延迟容忍度很低。

## Navigation Timing API 性能指标
> 为了帮助开发者更好的衡量和改进前端页面性能，W3C性能小组引进了Navigation Timing API，实现了自动，精准的页面性能打点，开发者可以通过window.performance属性获取。

1. performance.timing 接口
2. performance.navigation

> 第一版的 Navigation Timing 的处理模型, 从当前浏览器窗口卸载旧页面开始，到新页面加载完成，整个过程一共被切分为 9 个小块：提示卸载旧文档、重定向/卸载、应用缓存、DNS 解析、TCP 握手、HTTP 请求处理、HTTP 响应处理、DOM 处理、文档装载完成。每个小块的首尾、中间做事件分界，取 Unix 时间戳，两两事件之间计算时间差，从而获取中间过程的耗时（精确到毫秒级别）。

## 采集页面性能的关键指标
> 使用这个API，我们可以计算许多重要的指标，如首字节的时间，页面加载时间，dns查找以及链接是否安全。

### 确认统计的起始点
> navigationStart: 相当于在 URL 输入栏回车或者页面按 F5 刷新的时间点
> fetchStart: 相当于浏览器准备好使用 HTTP 请求获取文档的时间

## 首字节
> 主文档返回第一个字节的时间，是页面加载性能比较重要的指标。对用户来说一般吾感至，对于开发者来说，则代表访问网络后端的整体响应耗时。

## 白屏时间
> 头部资源正在加载时，页面是白屏
> 可以取 domLoading - fetchStart，此时页面开始解析 DOM 树，页面渲染的第一个元素也会很快出现。
> 也可以采用domInteractive - fetchStart, 此时页面资源加载完成，即将进入渲染环节。

## 首屏时间
> 指页面第一屏所有资源完整展示的时间。
> DOM树已经解析完成并显示内容。

## SPA
> Navigation Timing API 可以监控大部分前端页面的性能。但随着 SPA 模式的盛行，类似 vue，reactjs 等框架的普及，页面内容渲染的时机被改变了，W3C 标准无法完全满足原来的监控意义。

> Navigation Timing API 可以监控大部分前端页面的性能。但随着 SPA 模式的盛行，类似 vue，reactjs 等框架的普及，页面内容渲染的时机被改变了，W3C 标准无法完全满足原来的监控意义。

> 通过 window.performance.timing 所获的的页面渲染所相关的数据，在 SPA 应用中改变了 url 但不刷新页面的情况下是不会更新的。因此仅仅通过该 api 是无法获得每一个子路由所对应的页面渲染的时间。如果需要上报切换路由情况下每一个子页面重新 render 的时间，需要自定义上报。

### 是否发生 
> 首次绘制（FP）
> 首次内容绘制（FCP）

### 是否有用
> 首次有效绘制（FMP）

### 是否可用
> 可交互时间（TTI）

### 是否令人愉快
> 耗时较长的任务

## 其他监控方式
### Profile 工具
> Performance Timing API 描述了页面资源从加载到解析各个阶段的执行关键点时间记录，但是无法统计 JavaScript 执行过程中系统资源的占用情况。Profile 是 Chrome 和 Firefox 等标准浏览器提供的一种用于测试页面脚本运行时系统内存和 CPU 资源占用情况的 API，以 Chrome 浏览器为例，结合 Profile，可以实现以下几个功能

1. 分析页面脚本执行过程中最耗资源的操作
2. 记录页面脚本执行过程中 JavaScript 对象消耗的内存与堆栈的使用情况
3. 检测页面脚本执行过程中 CPU 占用情况

### 页面埋点计时
> 使用 Profile 可以在一定程度上帮助我们分析页面的性能，但缺点是不够灵活。实际项目中，我们不会多关注页面的内存或 CPU 资源的消耗情况，因为 JavaScript 有自动内存回收机制。

> 页面 JavaScript 埋点计时比较容易实现，和 Performance Timing 记录时间戳有点类似，我们可以记录 JavaScript 代码开始执行的时间戳，后面在需要记录的地方埋点记录结束时的时间戳，最后通过差值来计算一段 HTML 解析或 JavaScript 解析执行的时间。

### 资源记载时序图

> 我们还可以借助浏览器或者其他工具中的资源加载时许图来帮助分析页面资源加载过程中的性能问题。
> 这种方法可以粗粒度地宏观分析浏览器的所有资源文件请求耗时和文件加载顺序情况。 
> 根据资源加载时序图我们可以很直观地看到页面上各个资源加载过程所需要的时间和先后顺序，有利于找出加载过程中比较耗时的文件资源，帮助我们有针对性地进行优化。


## 数据上报方式
### img标签
> 不存在AJAX跨域问题，可做跨源的请求
> 没有浏览器兼容性的问题

### navigator.sendBeacon
> 大部分现代浏览器都支持 navigator.sendBeacon 方法。这个方法可以用来发送一些统计和诊断的小量数据，特别适合上报统计的场景。

> 数据可靠，浏览器关闭请求也照样能发
> 异步执行，不会影响下一页面的加载
> API 使用简单


